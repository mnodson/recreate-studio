<app-admin-subnav></app-admin-subnav>
<div class="analytics-dashboard">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1 class="dashboard-title">Analytics Dashboard</h1>
      <p class="dashboard-subtitle">Track your business performance and insights</p>
    </div>

    <!-- Date Range Selector -->
    <div class="date-range-selector">
      <button
        class="date-range-btn"
        [class.active]="selectedDateRange() === 'week'"
        (click)="setDateRange('week')">
        Last 7 Days
      </button>
      <button
        class="date-range-btn"
        [class.active]="selectedDateRange() === 'month'"
        (click)="setDateRange('month')">
        Last 30 Days
      </button>
      <button
        class="date-range-btn"
        [class.active]="selectedDateRange() === 'quarter'"
        (click)="setDateRange('quarter')">
        Last 90 Days
      </button>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Loading analytics...</p>
    </div>
  }

  <!-- Dashboard Content -->
  @if (!loading() && metrics()) {
    <!-- Metric Cards -->
    <div class="metrics-grid">
      @for (card of metricCards(); track card.title) {
        <div class="metric-card">
          @if (card.icon) {
            <div class="metric-icon">
              @switch (card.icon) {
                @case ('mail') {
                  <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                    <polyline points="22,6 12,13 2,6"></polyline>
                  </svg>
                }
                @case ('eye') {
                  <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                }
                @case ('image') {
                  <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                  </svg>
                }
                @case ('tag') {
                  <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                    <line x1="7" y1="7" x2="7.01" y2="7"></line>
                  </svg>
                }
              }
            </div>
          }
          <div class="metric-content">
            <h3 class="metric-title">{{ card.title }}</h3>
            <div class="metric-value">{{ card.value }}</div>
            @if (card.change !== undefined && card.trend) {
              <div class="metric-change" [class]="getTrendClass(card.trend)">
                <span class="trend-icon">{{ getTrendIcon(card.trend) }}</span>
                <span>{{ formatChange(card.change) }}</span>
                @if (card.changeLabel) {
                  <span class="change-label">{{ card.changeLabel }}</span>
                }
              </div>
            }
          </div>
        </div>
      }
    </div>

    <!-- Tab Navigation -->
    <div class="tabs-container">
      <div class="tabs">
        <button
          class="tab"
          [class.active]="selectedTab() === 'overview'"
          (click)="setTab('overview')">
          Overview
        </button>
        <button
          class="tab"
          [class.active]="selectedTab() === 'inquiries'"
          (click)="setTab('inquiries')">
          Inquiries
        </button>
        <button
          class="tab"
          [class.active]="selectedTab() === 'galleries'"
          (click)="setTab('galleries')">
          Galleries
        </button>
        <button
          class="tab"
          [class.active]="selectedTab() === 'promotions'"
          (click)="setTab('promotions')">
          Promotions
        </button>
      </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Overview Tab -->
      @if (selectedTab() === 'overview') {
        <div class="overview-tab">
          <div class="chart-grid">
            <div class="chart-card">
              <h3 class="chart-title">Inquiries Over Time</h3>
              <div class="chart-container">
                <canvas #inquiriesChart></canvas>
              </div>
            </div>

            <div class="chart-card">
              <h3 class="chart-title">Inquiry Types</h3>
              <div class="chart-container">
                @if (metrics()?.inquiriesByType && metrics()!.inquiriesByType.length > 0) {
                  <canvas #inquiryTypeChart></canvas>
                } @else {
                  <div class="empty-chart-state">
                    <p>No inquiry data available for the selected date range</p>
                    <small>Try selecting a different date range or check back after receiving inquiries</small>
                  </div>
                }
              </div>
            </div>
          </div>
        </div>
      }

      <!-- Inquiries Tab -->
      @if (selectedTab() === 'inquiries') {
        <div class="inquiries-tab">
          <div class="chart-grid">
            <div class="chart-card full-width">
              <h3 class="chart-title">Inquiry Trends</h3>
              <div class="chart-container large">
                <canvas #inquiriesChart></canvas>
              </div>
            </div>

            <div class="chart-card">
              <h3 class="chart-title">Inquiry Types Distribution</h3>
              <div class="chart-container">
                @if (metrics()?.inquiriesByType && metrics()!.inquiriesByType.length > 0) {
                  <canvas #inquiryTypeChart></canvas>
                } @else {
                  <div class="empty-chart-state">
                    <p>No inquiry data available for the selected date range</p>
                    <small>Try selecting a different date range or check back after receiving inquiries</small>
                  </div>
                }
              </div>
              @if (metrics()?.inquiriesByType && metrics()!.inquiriesByType.length > 0) {
                <div class="inquiry-type-list">
                  @for (type of metrics()?.inquiriesByType; track type.type) {
                    <div class="inquiry-type-item">
                      <span class="type-name">{{ type.type }}</span>
                      <span class="type-count">{{ type.count }} ({{ type.percentage.toFixed(1) }}%)</span>
                    </div>
                  }
                </div>
              }
            </div>

            @if (metrics()?.packageInterest && metrics()!.packageInterest.length > 0) {
              <div class="chart-card">
                <h3 class="chart-title">Package Interest</h3>
                <div class="chart-container">
                  <canvas #packageInterestChart></canvas>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Galleries Tab -->
      @if (selectedTab() === 'galleries') {
        <div class="galleries-tab">
          <div class="gallery-stats-card">
            <h3 class="section-title">Top Performing Galleries</h3>
            @if (metrics()?.topGalleries && metrics()!.topGalleries.length > 0) {
              <div class="gallery-table">
                <table>
                  <thead>
                    <tr>
                      <th>Gallery Title</th>
                      <th>Client</th>
                      <th>Views</th>
                      <th>Images</th>
                      <th>Last Accessed</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (gallery of metrics()?.topGalleries; track gallery.galleryId) {
                      <tr>
                        <td class="gallery-title">{{ gallery.title }}</td>
                        <td>{{ gallery.clientName }}</td>
                        <td class="views-count">{{ gallery.views }}</td>
                        <td>{{ gallery.imageCount }}</td>
                        <td class="last-accessed">
                          @if (gallery.lastAccessed) {
                            {{ toDate(gallery.lastAccessed) | date: 'shortDate' }}
                          } @else {
                            <span class="text-muted">Never</span>
                          }
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            } @else {
              <div class="empty-state">
                <p>No gallery views yet in this period</p>
              </div>
            }
          </div>
        </div>
      }

      <!-- Promotions Tab -->
      @if (selectedTab() === 'promotions') {
        <div class="promotions-tab">
          <div class="promotion-stats-card">
            <h3 class="section-title">Active Promotions</h3>
            @if (metrics()?.promotionStats && metrics()!.promotionStats.length > 0) {
              <div class="promotion-grid">
                @for (promo of metrics()?.promotionStats; track promo.promotion.id) {
                  <div class="promotion-card">
                    <div class="promotion-header">
                      <h4>{{ promo.promotion.name }}</h4>
                      <span class="promotion-badge">Active</span>
                    </div>
                    <div class="promotion-details">
                      <div class="detail-item">
                        <span class="detail-label">Type:</span>
                        <span class="detail-value">
                          @if (promo.promotion.discountType === 'percentage') {
                            {{ promo.promotion.discountValue }}% Off
                          } @else {
                            ${{ promo.promotion.discountValue }} Off
                          }
                        </span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Scope:</span>
                        <span class="detail-value">{{ promo.promotion.isSiteWide ? 'Site-wide' : 'Specific Packages' }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Dates:</span>
                        <span class="detail-value">
                          {{ toDate(promo.promotion.startDate) | date: 'mediumDate' }} - {{ toDate(promo.promotion.endDate) | date: 'mediumDate' }}
                        </span>
                      </div>
                    </div>
                    <div class="promotion-note">
                      <p class="note-text">
                        <strong>Note:</strong> Promotion analytics (views, clicks, CTR) will be available once Firebase Analytics BigQuery export is configured.
                      </p>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="empty-state">
                <p>No active promotions</p>
                <button class="cta-button" (click)="navigateToPromotionAdmin()">Create Promotion</button>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
</div>
